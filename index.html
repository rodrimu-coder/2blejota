<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>doblejotaenlared Score (Vrodimu10)</title>
<style>
Â  :root{
Â  Â  --bg:#0b0f19; --panel:#101623; --line:#1e293b; --txt:#e5e7eb; --muted:#94a3b8;
Â  Â  --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --btn:#1f2937; --ring:#22d3ee;
Â  }
Â  /* Estilos mÃ­nimos para asegurar que no se vea "fea" */
Â  *{box-sizing:border-box}
Â  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
Â  .wrap{max-width:980px;margin:auto;padding:12px}
Â  h1, h2, .help, .card, input, select, .btn, .kpi .box, .score, .log, table{
Â  Â  /* Asegurar que los componentes principales usen los colores */
Â  Â  background: var(--panel); 
Â  Â  color: var(--txt);
Â  Â  border-color: var(--line);
Â  }
Â  
Â  /* El resto de tus estilos originales... */
Â  h1{margin:4px 0 10px;font-size:18px}
Â  h2{margin:8px 0;font-size:15px;color:#cbd5e1}
Â  .help{font-size:12px;color:var(--muted); background:transparent}
Â  .row{display:grid;gap:10px}
Â  @media(min-width:860px){.row.cols-2{grid-template-columns:1fr 1fr}}
Â  @media(min-width:980px){.row.cols-3{grid-template-columns:1fr .9fr 1fr}}
Â  .card{border:1px solid var(--line);border-radius:10px;padding:10px}
Â  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--txt);outline:none}
Â  input:focus,select:focus{border-color:var(--ring)}
Â  .btn{cursor:pointer;border:1px solid var(--line);background:#0f172a;color:var(--txt);padding:10px;border-radius:10px;font-weight:600}
Â  .btn:active{transform:translateY(1px)}
Â  .btn.ok{background:#0e2a19;border-color:#14532d}
Â  .btn.bad{background:#2a1111;border-color:#7f1d1d}
Â  .btn.ghost{background:transparent}
Â  .grid{display:grid;gap:8px}
Â  .grid.cols-2{grid-template-columns:1fr 1fr}
Â  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#cbd5e1; background:var(--panel)}
Â  .score{display:flex;align-items:center;justify-content:space-between;gap:6px;border:1px dashed var(--line);padding:8px;border-radius:10px}
Â  .big{font-size:24px;font-weight:800}
Â  .kpi{display:flex;gap:8px;flex-wrap:wrap}
Â  .kpi .box{border:1px solid var(--line);border-radius:10px;padding:8px 10px}
Â  .kpi .n{font-size:18px;font-weight:800}
Â  .log{max-height:210px;overflow:auto;border:1px solid var(--line);border-radius:10px; background:var(--panel)}
Â  table{width:100%;border-collapse:collapse;font-size:12px; background:var(--panel)}
Â  th,td{padding:6px 8px;border-bottom:1px solid var(--line);white-space:nowrap}
Â  .gp{border:2px solid var(--warn)}
Â  .pill-warn{background:#2a1f0e;border:1px solid #8a6a0a;color:#f8d36c}
Â  .sep{height:1px;background:var(--line);margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
Â  <h1>ðŸŽ¾ doblejotaenlared â€” Marcador de PÃ¡del (punto de oro)</h1>

Â  <div class="card">
Â  Â  <h2>1) ConfiguraciÃ³n</h2>
Â  Â  <div class="row cols-2">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="grid">
Â  Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  Â  <div><div class="help">A1</div><input id="pA1" value="A1" /></div>
Â  Â  Â  Â  Â  Â  <div><div class="help">A2</div><input id="pA2" value="A2" /></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  Â  <div><div class="help">B1</div><input id="pB1" value="B1" /></div>
Â  Â  Â  Â  Â  Â  <div><div class="help">B2</div><input id="pB2" value="B2" /></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="grid">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="help">Orden de servicio (quiÃ©n saca primero y rotaciÃ³n)</div>
Â  Â  Â  Â  Â  Â  <select id="serveOrder"></select>
Â  Â  Â  Â  Â  Â  <div class="help">RotaciÃ³n: Servidor â†’ siguiente de la lista.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="help">Formato de sets</div>
Â  Â  Â  Â  Â  Â  <select id="setFormat">
Â  Â  Â  Â  Â  Â  Â  <option value="1">1 set (6 juegos, +2, sin tiebreak)</option>
Â  Â  Â  Â  Â  Â  Â  <option value="3" selected>Mejor de 3</option>
Â  Â  Â  Â  Â  Â  Â  <option value="5">Mejor de 5</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  Â  <button id="btnStart" class="btn ok">Iniciar/Resetear</button>
Â  Â  Â  Â  Â  Â  <button id="btnUndo" class="btn">Deshacer punto</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  Â  <button id="btnEndSet" class="btn">Cerrar set</button>
Â  Â  Â  Â  Â  Â  <button id="btnEndMatch" class="btn bad">Terminar</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="sep"></div>

Â  Â  <h2>2) Tablero</h2>
Â  Â  <div class="row cols-3">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div id="teamATitle" class="help">Equipo A</div>
Â  Â  Â  Â  <div class="kpi">
Â  Â  Â  Â  Â  <div class="box"><div class="help">Sets</div><div id="setsA" class="n">0</div></div>
Â  Â  Â  Â  Â  <div class="box"><div class="help">Juegos (set)</div><div id="gamesA" class="n">0</div></div>
Â  Â  Â  Â  Â  <div class="box"><div class="help">Puntos (juego)</div><div id="pointsA" class="n">0</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div id="scoreBox" class="card">
Â  Â  Â  Â  <div class="score">
Â  Â  Â  Â  Â  <div><div class="help">Servidor</div><div class="badge" id="serverNow">-</div></div>
Â  Â  Â  Â  Â  <div class="big" id="tennisScore">0 â€” 0</div>
Â  Â  Â  Â  Â  <div><div class="help">Estado</div><div class="badge" id="stateNow">Listo</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="gpNote" class="help" style="margin-top:6px">A 40â€“40 hay <b>Punto de Oro</b>.</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div id="teamBTitle" class="help">Equipo B</div>
Â  Â  Â  Â  <div class="kpi">
Â  Â  Â  Â  Â  <div class="box"><div class="help">Sets</div><div id="setsB" class="n">0</div></div>
Â  Â  Â  Â  Â  <div class="box"><div class="help">Juegos (set)</div><div id="gamesB" class="n">0</div></div>
Â  Â  Â  Â  Â  <div class="box"><div class="help">Puntos (juego)</div><div id="pointsB" class="n">0</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <h2 style="margin-top:8px">3) Registrar punto</h2>
Â  Â  <div class="row cols-2" id="actionsGrid">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="help">Equipo A â€” Acciones</div>
Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  <button class="btn ok" data-player="A1" data-action="GG">A1 Â· GG</button>
Â  Â  Â  Â  Â  <button class="btn ok" data-player="A1" data-action="SG">A1 Â· SG</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="A1" data-action="ENF">A1 Â· ENF</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="A1" data-action="FE">A1 Â· FE</button>

Â  Â  Â  Â  Â  <button class="btn ok" data-player="A2" data-action="GG">A2 Â· GG</button>
Â  Â  Â  Â  Â  <button class="btn ok" data-player="A2" data-action="SG">A2 Â· SG</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="A2" data-action="ENF">A2 Â· ENF</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="A2" data-action="FE">A2 Â· FE</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="help">Equipo B â€” Acciones</div>
Â  Â  Â  Â  <div class="grid cols-2">
Â  Â  Â  Â  Â  <button class="btn ok" data-player="B1" data-action="GG">B1 Â· GG</button>
Â  Â  Â  Â  Â  <button class="btn ok" data-player="B1" data-action="SG">B1 Â· SG</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="B1" data-action="ENF">B1 Â· ENF</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="B1" data-action="FE">B1 Â· FE</button>

Â  Â  Â  Â  Â  <button class="btn ok" data-player="B2" data-action="GG">B2 Â· GG</button>
Â  Â  Â  Â  Â  <button class="btn ok" data-player="B2" data-action="SG">B2 Â· SG</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="B2" data-action="ENF">B2 Â· ENF</button>
Â  Â  Â  Â  Â  <button class="btn"Â  Â  data-player="B2" data-action="FE">B2 Â· FE</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="row cols-2" style="margin-top:8px">
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="help">EstadÃ­sticas por jugadora</div>
Â  Â  Â  Â  <div id="statsPlayers" class="help">Sin datos.</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="help">Historial del partido</div>
Â  Â  Â  Â  <div class="log">
Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  <thead><tr><th>#</th><th>Evento</th><th>Tipo</th><th>Equipo</th><th>Marcador</th><th>Servidor</th></tr></thead>
Â  Â  Â  Â  Â  Â  <tbody id="tblLog"></tbody>
Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="grid cols-2" style="margin-top:8px">
Â  Â  Â  Â  Â  <button id="btnExport" class="btn">Exportar CSV</button>
Â  Â  Â  Â  Â  <button id="btnSave" class="btn">Guardar (mÃ¡x. 4)</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <h2 style="margin-top:8px">4) Ãšltimos 4 partidos guardados</h2>
Â  Â  <div class="card"><div id="savedList" class="help">No hay partidos.</div></div>
Â  </div>
</div>

<script>
/* ========= Estado y helpers ========= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const state = {
Â  meta:{ started:false, finished:false, setFormat:3, createdAt:null, id:null },
Â  players:{ A1:{name:"A1"}, A2:{name:"A2"}, B1:{name:"B1"}, B2:{name:"B2"} },
Â  serveOrder:["A1","B1","A2","B2"],
Â  serveIndex:0,
Â  score:{ setsA:0, setsB:0, gamesA:0, gamesB:0, ptsA:0, ptsB:0 },
Â  stats:{ A1:{GG:0,SG:0,ENF:0,FE:0}, A2:{GG:0,SG:0,ENF:0,FE:0}, B1:{GG:0,SG:0,ENF:0,FE:0}, B2:{GG:0,SG:0,ENF:0,FE:0} },
Â  log:[],
Â  undoStack:[],
Â  eventsSinceSave:0
};
const KEY_AUTOSAVE="DJR_autosave_fast_v1", KEY_SAVED="DJR_saved_fast_v1";

const deepClone = o => JSON.parse(JSON.stringify(o));
const teamOf = id => id[0]==="A" ? "A" : "B";
const serverId = () => state.serveOrder[state.serveIndex] || "A1";
const serverName = () => state.players[serverId()]?.name || serverId();
const nextServer = () => state.serveIndex = (state.serveIndex + 1) % state.serveOrder.length;
const resetGamePoints = () => { state.score.ptsA = 0; state.score.ptsB = 0; };

function tennisStr(a,b){
Â  const map = ["0","15","30","40"];
Â  
Â  // 1. CASOS DE JUEGO GANADO (se muestra justo antes del reset de puntos)
Â  if ((a >= 4 || b >= 4) && Math.abs(a-b)>=1) { 
Â  Â  if (a > b) return "Gana A (Juego)";
Â  Â  if (b > a) return "Gana B (Juego)";
Â  }
Â  
Â  // 2. CASO ESPECIAL: 40-40 (Punto de Oro)
Â  if (a>=3 && b>=3 && a===b) return "GP"; 
Â  
Â  // 3. Marcadores normales
Â  const sa = (a>=3)?"40":(map[a]||"40"), sb = (b>=3)?"40":(map[b]||"40");
Â  return `${sa} â€” ${sb}`;
}
function isGoldenPoint(){ return state.score.ptsA>=3 && state.score.ptsB>=3 && state.score.ptsA===state.score.ptsB; }

function syncNames(){
Â  state.players.A1.name = $("#pA1").value.trim() || "A1";
Â  state.players.A2.name = $("#pA2").value.trim() || "A2";
Â  state.players.B1.name = $("#pB1").value.trim() || "B1";
Â  state.players.B2.name = $("#pB2").value.trim() || "B2";
}

function updateServeOrderOptions(){
Â  const n = state.players;
Â  const opts = [
Â  Â  ["A1,B1,A2,B2", `A1 (${n.A1.name}) â†’ B1 (${n.B1.name}) â†’ A2 (${n.A2.name}) â†’ B2 (${n.B2.name})`],
Â  Â  ["A1,B2,A2,B1", `A1 (${n.A1.name}) â†’ B2 (${n.B2.name}) â†’ A2 (${n.A2.name}) â†’ B1 (${n.B1.name})`],
Â  Â  ["B1,A1,B2,A2", `B1 (${n.B1.name}) â†’ A1 (${n.A1.name}) â†’ B2 (${n.B2.name}) â†’ A2 (${n.A2.name})`],
Â  Â  ["B2,A1,B1,A2", `B2 (${n.B2.name}) â†’ A1 (${n.A1.name}) â†’ B1 (${n.B1.name}) â†’ A2 (${n.A2.name})`],
Â  ];
Â  const sel = $("#serveOrder");
Â  sel.innerHTML = opts.map(([v,t])=>`<option value="${v}">${t}</option>`).join("");
Â  const current = state.serveOrder.join(",");
Â  if ([...sel.options].some(o=>o.value===current)) sel.value = current;
}

function updateActionLabels(){
Â  const nameOf = id => state.players[id]?.name || id;
Â  ["A1","A2","B1","B2"].forEach(id=>{
Â  Â  ["GG","SG","ENF","FE"].forEach(act=>{
Â  Â  Â  const btn = document.querySelector(`button[data-player="${id}"][data-action="${act}"]`);
Â  Â  Â  if (btn) btn.textContent = `${nameOf(id)} Â· ${act}`;
Â  Â  });
Â  });
}

function pushUndo(){ state.undoStack.push(deepClone(state)); if (state.undoStack.length>100) state.undoStack.shift(); }
function undo(){ if(!state.undoStack.length) return; const prev=state.undoStack.pop(); Object.keys(state).forEach(k=>delete state[k]); Object.assign(state,prev); render(); }

/* ========= LÃ³gica de juego ========= */
function closeGameIfNeeded(){
Â  const a = state.score.ptsA, b = state.score.ptsB;
Â  
Â  // Si estamos en 40-40 (3-3), NO cerramos el juego, el siguiente punto lo cerrarÃ¡ (GP)
Â  if (a>=3 && b>=3 && a===b) return false; 
Â  
Â  let winner=null;
Â  // El juego se cierra si un equipo tiene 4 o mÃ¡s puntos.
Â  if (a>=4 || b>=4) winner = (a>b)?"A":"B";
Â  
Â  if (winner){
Â  Â  if (winner==="A") state.score.gamesA++; else state.score.gamesB++;
Â  Â  resetGamePoints(); nextServer();
Â  Â  return true;
Â  }
Â  return false;
}

function checkSetEnd(){
Â  const gA=state.score.gamesA, gB=state.score.gamesB, need=6;
Â  
Â  // La condiciÃ³n de cierre de set es: >=6 juegos Y una diferencia >= 2.
Â  if ((gA>=need || gB>=need) && Math.abs(gA-gB)>=2){
Â  Â  if (gA>gB) state.score.setsA++; else state.score.setsB++;
Â  Â  state.score.gamesA=0; state.score.gamesB=0; resetGamePoints();
Â  Â  const targetSets = Math.ceil(state.meta.setFormat/2);
Â  Â  if (state.score.setsA===targetSets || state.score.setsB===targetSets) state.meta.finished=true;
Â  }
}

function recordPoint(playerId, type){
Â  if (!state.meta.started || state.meta.finished) return;
Â  pushUndo();

Â  let winnerTeam;
Â  // 1. Registrar el punto en el estado
Â  if (type==="GG" || type==="SG"){
Â  Â  winnerTeam = teamOf(playerId);
Â  Â  state.stats[playerId][type] += 1;
Â  } else {
Â  Â  state.stats[playerId][type] += 1;
Â  Â  winnerTeam = teamOf(playerId)==="A" ? "B" : "A";
Â  }
Â  if (winnerTeam==="A") state.score.ptsA++; else state.score.ptsB++;

Â  // Captura el marcador de puntos justo despuÃ©s de anotar (antes del reset).
Â  const pointStr = tennisStr(state.score.ptsA, state.score.ptsB);
Â  const eventGameStr = `${pointStr} | Juegos ${state.score.gamesA}-${state.score.gamesB}`;

Â  // 2. Cerrar juego y set (Esto incrementa gamesA/B y resetea ptsA/B si cerrÃ³)
Â  const closed = closeGameIfNeeded();
Â  if (closed) checkSetEnd();

Â  // 3. Registrar el evento en el log (usa la cadena capturada antes del reset)
Â  const evento = (type==="ENF"||type==="FE") ? `Error ${state.players[playerId].name}` : state.players[playerId].name;
Â  state.log.push({ n: state.log.length+1, evento, type, winnerTeam, gameStr: eventGameStr, server: serverName() });

Â  state.eventsSinceSave++;
Â  render();
Â  if (state.eventsSinceSave>=5) { autosave(); state.eventsSinceSave=0; }
}

/* ========= Persistencia y Render (Sin Cambios LÃ³gicos Mayores) ========= */
function autosave(){ try{ localStorage.setItem(KEY_AUTOSAVE, JSON.stringify(state)); }catch(e){} }
function loadAutosave(){
Â  try{
Â  Â  const raw=localStorage.getItem(KEY_AUTOSAVE); if(!raw) return false;
Â  Â  const st=JSON.parse(raw); Object.keys(state).forEach(k=>delete state[k]); Object.assign(state,st); return true;
Â  }catch(e){ return false; }
}
function saveToHistory(){
Â  try{
Â  Â  const arr = JSON.parse(localStorage.getItem(KEY_SAVED) || "[]");
Â  Â  const snap = deepClone(state); snap.savedAt = new Date().toISOString();
Â  Â  arr.unshift(snap); while(arr.length>4) arr.pop();
Â  Â  localStorage.setItem(KEY_SAVED, JSON.stringify(arr));
Â  Â  renderSaved(); alert("Guardado en historial.");
Â  }catch(e){ alert("No se pudo guardar."); }
}
function renderSaved(){
Â  const box=$("#savedList"); const arr=JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
Â  if(!arr.length){ box.textContent="No hay partidos."; return; }
Â  box.innerHTML = arr.map((m,i)=>{
Â  Â  const t=new Date(m.savedAt||m.meta?.createdAt||Date.now()).toLocaleString();
Â  Â  const A=`${m.players.A1.name} & ${m.players.A2.name}`, B=`${m.players.B1.name} & ${m.players.B2.name}`;
Â  Â  const res=`${m.score.setsA}-${m.score.setsB} sets`;
Â  Â  return `<div class="score">
Â  Â  Â  <div><div class="help">#${i+1} Â· ${t}</div><div>${A} <span class="help">vs</span> ${B}</div><div class="help">${res}</div></div>
Â  Â  Â  <div class="grid" style="grid-template-columns:auto auto auto;gap:6px">
Â  Â  Â  Â  <button class="btn ghost" data-load="${i}">Cargar</button>
Â  Â  Â  Â  <button class="btn bad" data-del="${i}">Borrar</button>
Â  Â  Â  Â  <button class="btn" data-export="${i}">CSV</button>
Â  Â  Â  </div>
Â  Â  </div>`;
Â  }).join("");
Â  box.querySelectorAll("[data-load]").forEach(b=> b.onclick=()=>{
Â  Â  const idx=+b.getAttribute("data-load"); const arr2=JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
Â  Â  const pick=arr2[idx]; if(!pick)return; Object.keys(state).forEach(k=>delete state[k]); Object.assign(state,pick); render();
Â  Â  window.scrollTo({top:0,behavior:"smooth"});
Â  });
Â  box.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>{
Â  Â  const idx=+b.getAttribute("data-del"); const arr2=JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
Â  Â  arr2.splice(idx,1); localStorage.setItem(KEY_SAVED, JSON.stringify(arr2)); renderSaved();
Â  });
Â  box.querySelectorAll("[data-export]").forEach(b=> b.onclick=()=>{
Â  Â  const idx=+b.getAttribute("data-export"); const arr2=JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
Â  Â  if(arr2[idx]) downloadCSV(buildCSV(arr2[idx]), `doblejotaenlared_guardado_${idx+1}.csv`);
Â  });
}

/* ========= CSV (Sin Cambios) ========= */
function buildCSV(snap){
Â  const s=snap||state; const L=[];
Â  L.push(["doblejotaenlared", new Date(s.meta.createdAt||Date.now()).toISOString(),
Â  Â  Â  Â  Â  `${s.players.A1.name} & ${s.players.A2.name}`,
Â  Â  Â  Â  Â  `${s.players.B1.name} & ${s.players.B2.name}`,
Â  Â  Â  Â  Â  `Sets ${s.score.setsA}-${s.score.setsB}`].join(","));
Â  L.push(""); L.push("EstadÃ­sticas por jugadora"); L.push("Jugadora,Equipo,GG,SG,ENF,FE");
Â  ["A1","A2","B1","B2"].forEach(id=>{
Â  Â  const r=s.stats[id]||{GG:0,SG:0,ENF:0,FE:0}; L.push([s.players[id].name, teamOf(id), r.GG, r.SG, r.ENF, r.FE].join(","));
Â  });
Â  L.push(""); L.push("Historial de puntos"); L.push("N,Evento,Tipo,Equipo,Marcador,Servidor");
Â  (s.log||[]).forEach(r=> L.push([r.n, `"${r.evento}"`, r.type, r.winnerTeam, `"${r.gameStr}"`, `"${r.server}"`].join(",")));
Â  L.push(""); L.push("Resumen final"); L.push(`Sets A,${s.score.setsA},Sets B,${s.score.setsB}`);
Â  return L.join("\r\n");
}
function downloadCSV(content, filename){
Â  const blob=new Blob([content],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
Â  const a=document.createElement("a"); a.href=url; a.download=filename||"doblejotaenlared.csv"; document.body.appendChild(a); a.click();
Â  document.body.removeChild(a); URL.revokeObjectURL(url);
}

/* ========= Render Ãºnico (rÃ¡pido) ========= */
function render(){
Â  // TÃ­tulos
Â  $("#teamATitle").textContent = `Equipo A: ${state.players.A1.name} & ${state.players.A2.name}`;
Â  $("#teamBTitle").textContent = `Equipo B: ${state.players.B1.name} & ${state.players.B2.name}`;
Â  // Marcador
Â  $("#setsA").textContent=state.score.setsA; $("#setsB").textContent=state.score.setsB;
Â  $("#gamesA").textContent=state.score.gamesA; $("#gamesB").textContent=state.score.gamesB;
Â  $("#pointsA").textContent=state.score.ptsA; $("#pointsB").textContent=state.score.ptsB;
Â  $("#tennisScore").textContent=tennisStr(state.score.ptsA,state.score.ptsB);
Â  $("#serverNow").textContent=serverName();
Â  $("#stateNow").textContent = state.meta.finished ? "Finalizado" : (state.meta.started ? "Juego en curso" : "Listo");
Â  // Punto de oro aviso
Â  const box=$("#scoreBox"), note=$("#gpNote");
Â  if (isGoldenPoint()){ box.classList.add("gp"); note.innerHTML = '<span class="pill-warn">PUNTO DE ORO</span>: la prÃ³xima pelota define el juego.'; }
Â  else { box.classList.remove("gp"); note.textContent = "A 40â€“40 hay Punto de Oro."; }

Â  // Log (pinta solo Ãºltimos 120 para mantener fluidez en mÃ³viles)
Â  const tbody=$("#tblLog"); const cut = state.log.slice(-120);
Â  tbody.innerHTML = cut.map(r=> `<tr><td>${r.n}</td><td>${r.evento}</td><td>${r.type}</td><td>${r.winnerTeam}</td><td>${r.gameStr}</td><td>${r.server}</td></tr>`).join("");

Â  // Stats
Â  const s=state.stats;
Â  $("#statsPlayers").innerHTML = `
Â  Â  <div class="grid cols-2">
Â  Â  Â  ${["A1","A2","B1","B2"].map(id=>{
Â  Â  Â  Â  const nm=state.players[id].name, t=teamOf(id), r=s[id];
Â  Â  Â  Â  return `<div class="kpi"><div class="box"><div class="help">${nm} (${t})</div>
Â  Â  Â  Â  Â  <div class="help">GG ${r.GG} Â· SG ${r.SG} Â· ENF ${r.ENF} Â· FE ${r.FE}</div></div></div>`;
Â  Â  Â  }).join("")}
Â  Â  </div>`;

Â  // Acciones y orden
Â  updateActionLabels();
Â  renderSaved();
}

/* ========= Start/Events ========= */
function startReset(){
Â  syncNames();
Â  state.meta.setFormat = parseInt($("#setFormat").value,10);
Â  const seq = ($("#serveOrder").value||"A1,B1,A2,B2").split(",").filter(x=>["A1","A2","B1","B2"].includes(x));
Â  state.serveOrder = seq.length ? seq : ["A1","B1","A2","B2"];
Â  state.serveIndex=0;
Â  state.score={setsA:0,setsB:0,gamesA:0,gamesB:0,ptsA:0,ptsB:0};
Â  ["A1","A2","B1","B2"].forEach(id=> state.stats[id]={GG:0,SG:0,ENF:0,FE:0});
Â  state.log=[]; state.undoStack=[]; state.meta.started=true; state.meta.finished=false;
Â  state.meta.createdAt=new Date().toISOString(); state.meta.id="match_"+Date.now();
Â  state.eventsSinceSave=0; updateServeOrderOptions(); render(); autosave();
}

// inputs â†’ nombres/orden live
["#pA1","#pA2","#pB1","#pB2"].forEach(sel=>{
Â  $(sel).addEventListener("input", ()=>{ syncNames(); updateServeOrderOptions(); render(); });
});

// delegaciÃ³n de clicks en acciones (rÃ¡pido y seguro)
$("#actionsGrid").addEventListener("click",(e)=>{
Â  const b=e.target.closest("button[data-player][data-action]"); if(!b) return;
Â  recordPoint(b.getAttribute("data-player"), b.getAttribute("data-action"));
});

// control
$("#btnStart").onclick=startReset;
$("#btnUndo").onclick=undo;
$("#btnEndSet").onclick=()=>{
Â  if(!state.meta.started || state.meta.finished) return;
Â  if(state.score.gamesA===state.score.gamesB){ alert("Empate de juegos: no se puede cerrar el set."); return; }
Â  pushUndo(); if(state.score.gamesA>state.score.gamesB) state.score.setsA++; else state.score.setsB++;
Â  state.score.gamesA=0; state.score.gamesB=0; resetGamePoints();
Â  const targetSets=Math.ceil(state.meta.setFormat/2); if(state.score.setsA===targetSets || state.score.setsB===targetSets) state.meta.finished=true;
Â  render(); autosave();
};
$("#btnEndMatch").onclick=()=>{ if(!state.meta.started) return; pushUndo(); state.meta.finished=true; render(); autosave(); };

$("#btnExport").onclick=()=> downloadCSV(buildCSV(), "doblejotaenlared.csv");
$("#btnSave").onclick=saveToHistory;

/* boot */
(function boot(){
Â  updateServeOrderOptions();
Â  const ok=loadAutosave();
Â  // reflejar nombres si venÃ­an de autosave
Â  $("#pA1").value=state.players.A1.name; $("#pA2").value=state.players.A2.name;
Â  $("#pB1").value=state.players.B1.name; $("#pB2").value=state.players.B2.name;
Â  updateServeOrderOptions(); render();
})();
</script>
</body>
</html>
