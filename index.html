<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>doblejotaenlared Â· Marcador PÃ¡del (V_Rodrimu)</title>
<style>
  :root{ --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --ring:#22d3ee; }
  *{ box-sizing:border-box }
  body{ margin:0; background:linear-gradient(180deg,#0b1223,#0f172a); color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial }
  .wrap{ max-width:1100px; margin:auto; padding:16px }
  .card{ background:rgba(17,24,39,.88); border:1px solid #0b1529; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
  h1{ margin:4px 0 12px; font-size:20px; letter-spacing:.3px }
  h2{ margin:8px 0; font-size:16px; color:#cbd5e1 }
  .row{ display:grid; gap:12px }
  @media(min-width:900px){ .row.cols-2{ grid-template-columns:1fr 1fr } }
  @media(min-width:1100px){ .row.cols-3{ grid-template-columns:1.1fr .8fr 1.1fr } }
  input,select{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:#0b1223; color:#e5e7eb; outline:none }
  input:focus,select:focus{ border-color:var(--ring); box-shadow:0 0 0 3px rgba(34,211,238,.25) }
  .btn{ cursor:pointer; border:1px solid #253042; background:linear-gradient(180deg,#1f2937,#111827); color:#e5e7eb; padding:12px 14px; border-radius:12px; font-weight:600 }
  .btn:hover{ filter:brightness(1.07) } .btn:active{ transform:translateY(1px) }
  .btn.acc{ background:linear-gradient(180deg,#16a34a,#15803d); border-color:#166534 }
  .btn.dng{ background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#7f1d1d }
  .btn.ghost{ background:transparent; border-color:#334155 }
  .grid{ display:grid; gap:12px }
  .grid.cols-2{ grid-template-columns:1fr 1fr }
  .badge{ display:inline-block; padding:4px 10px; border-radius:999px; background:#0b1223; border:1px solid #334155; color:#cbd5e1; font-size:12px }
  .score{ display:flex; align-items:center; justify-content:space-between; gap:8px; border:1px dashed #334155; padding:10px; border-radius:12px }
  .big{ font-size:28px; font-weight:800; letter-spacing:.5px }
  .team{ padding:10px; border:1px solid #253042; border-radius:14px; background:#0b1223 }
  .team h3{ margin:0 0 6px; font-size:15px; color:#a5b4fc }
  .player{ display:flex; align-items:center; gap:8px; margin-bottom:8px }
  .player input{ flex:1 }
  .tiny{ font-size:12px; color:#94a3b8 }
  .tabbar{ display:flex; gap:8px; flex-wrap:wrap }
  .tabbar .btn{ padding:8px 10px }
  .log{ max-height:220px; overflow:auto; border:1px solid #253042; border-radius:12px; background:#0b1223 }
  .log table{ width:100%; border-collapse:collapse; font-size:13px }
  .log th,.log td{ padding:8px 10px; border-bottom:1px solid #1f2937; white-space:nowrap }
  .help{ font-size:12px; color:#9ca3af; margin-top:6px }
  .sep{ height:1px; background:#1f2937; margin:10px 0 }
  .kpi{ display:flex; gap:8px; flex-wrap:wrap }
  .kpi .box{ background:#0b1223; border:1px solid #334155; border-radius:12px; padding:10px 12px }
  .kpi .box .n{ font-size:20px; font-weight:800 }
  footer{ margin-top:18px; color:#64748b; font-size:12px; text-align:center }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸŽ¾ doblejotaenlared â€” Marcador de PÃ¡del (punto de oro)</h1>
    <div class="help">
      4 jugadoras, 2 vs 2. PuntuaciÃ³n tipo tenis con <b>punto de oro</b> a 40â€“40 (GP): la siguiente pelota define el juego.
      Marca por jugadora: <b>GG</b> (Golpe Ganador), <b>SG</b> (Saque Ganador), <b>ENF</b> (Error No Forzado), <b>FE</b> (Error Forzado).
      Guarda los Ãºltimos 4 partidos y exporta CSV.
    </div>

    <!-- CONFIGURACIÃ“N -->
    <h2>1) ConfiguraciÃ³n inicial</h2>
    <div class="row cols-2">
      <div class="team">
        <h3>Equipo A (izquierda)</h3>
        <div class="player"><span class="badge">A1</span><input id="pA1" placeholder="Nombre jugadora A1" value="A1" /></div>
        <div class="player"><span class="badge">A2</span><input id="pA2" placeholder="Nombre jugadora A2" value="A2" /></div>
      </div>
      <div class="team">
        <h3>Equipo B (derecha)</h3>
        <div class="player"><span class="badge">B1</span><input id="pB1" placeholder="Nombre jugadora B1" value="B1" /></div>
        <div class="player"><span class="badge">B2</span><input id="pB2" placeholder="Nombre jugadora B2" value="B2" /></div>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:8px">
      <div>
        <label class="tiny">Orden de servicio (quiÃ©n saca primero y rotaciÃ³n)</label>
        <select id="serveOrder"></select>
        <div class="help">RotaciÃ³n por juegos: Servidor actual â†’ siguiente de la lista (A1 â†’ B1 â†’ A2 â†’ B2 â†’ ...).</div>
      </div>
      <div>
        <label class="tiny">Formato de sets</label>
        <select id="setFormat">
          <option value="1">1 set (6 juegos, +2, sin tiebreak)</option>
          <option value="3" selected>Mejor de 3 sets (6 juegos, +2, sin tiebreak)</option>
          <option value="5">Mejor de 5 sets (6 juegos, +2, sin tiebreak)</option>
        </select>
      </div>
    </div>

    <div class="tabbar" style="margin-top:10px">
      <button class="btn acc" id="btnStart">Iniciar/Resetear Partido</button>
      <button class="btn ghost" id="btnUndo">Deshacer Ãºltimo punto</button>
      <button class="btn" id="btnEndSet">Cerrar set manual</button>
      <button class="btn dng" id="btnEndMatch">Terminar partido</button>
    </div>

    <div class="sep"></div>

    <!-- TABLERO -->
    <h2>2) Tablero de marcador</h2>
    <div class="row cols-3">
      <div class="team">
        <h3 id="nameTeamA">Equipo A</h3>
        <div class="kpi">
          <div class="box"><div class="tiny">Sets</div><div id="setsA" class="n">0</div></div>
          <div class="box"><div class="tiny">Juegos (set)</div><div id="gamesA" class="n">0</div></div>
          <div class="box"><div class="tiny">Puntos (juego)</div><div id="pointsA" class="n">0</div></div>
        </div>
      </div>
      <div class="card" style="background:#0b1223;border-color:#334155">
        <div class="score">
          <div><span class="tiny">Servidor</span><div class="badge" id="serverNow">-</div></div>
          <div class="big" id="tennisScore">0 â€” 0</div>
          <div><span class="tiny">Estado</span><div class="badge" id="stateNow">Listo</div></div>
        </div>
        <div class="help">A 40â€“40 se muestra <b>GP</b> (punto de oro): la prÃ³xima pelota define el juego.</div>
      </div>
      <div class="team">
        <h3 id="nameTeamB">Equipo B</h3>
        <div class="kpi">
          <div class="box"><div class="tiny">Sets</div><div id="setsB" class="n">0</div></div>
          <div class="box"><div class="tiny">Juegos (set)</div><div id="gamesB" class="n">0</div></div>
          <div class="box"><div class="tiny">Puntos (juego)</div><div id="pointsB" class="n">0</div></div>
        </div>
      </div>
    </div>

    <!-- REGISTRO DE PUNTOS -->
    <h2 style="margin-top:12px">3) Registrar punto por jugadora</h2>
    <div class="grid cols-2" id="actionsGrid">
      <div class="team">
        <h3>Equipo A â€” Acciones</h3>
        <div class="grid cols-2">
          <button class="btn acc" data-action="GG" data-player="A1">A1 Â· GG</button>
          <button class="btn acc" data-action="SG" data-player="A1">A1 Â· SG</button>
          <button class="btn" data-action="ENF" data-player="A1">A1 Â· ENF</button>
          <button class="btn" data-action="FE" data-player="A1">A1 Â· FE</button>

          <button class="btn acc" data-action="GG" data-player="A2">A2 Â· GG</button>
          <button class="btn acc" data-action="SG" data-player="A2">A2 Â· SG</button>
          <button class="btn" data-action="ENF" data-player="A2">A2 Â· ENF</button>
          <button class="btn" data-action="FE" data-player="A2">A2 Â· FE</button>
        </div>
      </div>
      <div class="team">
        <h3>Equipo B â€” Acciones</h3>
        <div class="grid cols-2">
          <button class="btn acc" data-action="GG" data-player="B1">B1 Â· GG</button>
          <button class="btn acc" data-action="SG" data-player="B1">B1 Â· SG</button>
          <button class="btn" data-action="ENF" data-player="B1">B1 Â· ENF</button>
          <button class="btn" data-action="FE" data-player="B1">B1 Â· FE</button>

          <button class="btn acc" data-action="GG" data-player="B2">B2 Â· GG</button>
          <button class="btn acc" data-action="SG" data-player="B2">B2 Â· SG</button>
          <button class="btn" data-action="ENF" data-player="B2">B2 Â· ENF</button>
          <button class="btn" data-action="FE" data-player="B2">B2 Â· FE</button>
        </div>
      </div>
    </div>

    <!-- RESÃšMENES -->
    <div class="row cols-2" style="margin-top:12px">
      <div class="team">
        <h3>EstadÃ­sticas por jugadora</h3>
        <div id="statsPlayers" class="help">Sin datos aÃºn.</div>
      </div>
      <div class="team">
        <h3>Historial del partido</h3>
        <div class="log">
          <table id="tblLog">
            <thead><tr><th>#</th><th>Evento</th><th>Tipo</th><th>Equipo</th><th>Marcador</th><th>Servidor</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tabbar" style="margin-top:8px">
          <button class="btn" id="btnExport">Exportar CSV</button>
          <button class="btn ghost" id="btnSave">Guardar en historial (mÃ¡x 4)</button>
        </div>
      </div>
    </div>

    <!-- HISTORIAL -->
    <h2 style="margin-top:12px">4) Ãšltimos 4 partidos guardados</h2>
    <div class="team">
      <div id="savedList" class="help">No hay partidos guardados todavÃ­a.</div>
    </div>

    <footer>Â© doblejotaenlared Â· offline (localStorage). Borrar datos del navegador elimina el historial.</footer>
  </div>
</div>

<script>
/* ========= Helpers de DOM ========= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* ========= Estado ========= */
const state = {
  meta:{ started:false, finished:false, setFormat:3, createdAt:null, id:null },
  players:{ A1:{name:"A1"}, A2:{name:"A2"}, B1:{name:"B1"}, B2:{name:"B2"} },
  serveOrder:["A1","B1","A2","B2"],
  serveIndex:0,
  score:{ setsA:0, setsB:0, gamesA:0, gamesB:0, ptsA:0, ptsB:0 },
  stats:{ A1:{GG:0,SG:0,ENF:0,FE:0}, A2:{GG:0,SG:0,ENF:0,FE:0}, B1:{GG:0,SG:0,ENF:0,FE:0}, B2:{GG:0,SG:0,ENF:0,FE:0} },
  log:[],
  undoStack:[]
};

const KEY_AUTOSAVE = "DJR_autosave_v3";
const KEY_SAVED    = "DJR_saved_v3";

/* ========= Utilidades ========= */
const deepClone = o => JSON.parse(JSON.stringify(o));
const teamOf = id => id[0]==="A" ? "A" : "B";
const serverId = () => state.serveOrder[state.serveIndex] || "A1";
const serverName = () => state.players[serverId()]?.name || serverId();
const nextServer = () => { state.serveIndex = (state.serveIndex + 1) % state.serveOrder.length; };
const resetGamePoints = () => { state.score.ptsA = 0; state.score.ptsB = 0; };

function tennisStr(a,b){
  const map = ["0","15","30","40"];
  if (a >= 3 && b >= 3 && a === b) return "GP"; // 40â€“40
  const sa = (a >= 3) ? "40" : (map[a] || "40");
  const sb = (b >= 3) ? "40" : (map[b] || "40");
  return `${sa} â€” ${sb}`;
}

function syncNamesFromInputs(){
  state.players.A1.name = $("#pA1").value.trim() || "A1";
  state.players.A2.name = $("#pA2").value.trim() || "A2";
  state.players.B1.name = $("#pB1").value.trim() || "B1";
  state.players.B2.name = $("#pB2").value.trim() || "B2";
}

function updateServeOrderOptions(){
  // Construye siempre 4 opciones vÃ¡lidas con nombres actuales
  const n = state.players;
  const opts = [
    ["A1,B1,A2,B2", `A1 (${n.A1.name}) â†’ B1 (${n.B1.name}) â†’ A2 (${n.A2.name}) â†’ B2 (${n.B2.name})`],
    ["A1,B2,A2,B1", `A1 (${n.A1.name}) â†’ B2 (${n.B2.name}) â†’ A2 (${n.A2.name}) â†’ B1 (${n.B1.name})`],
    ["B1,A1,B2,A2", `B1 (${n.B1.name}) â†’ A1 (${n.A1.name}) â†’ B2 (${n.B2.name}) â†’ A2 (${n.A2.name})`],
    ["B2,A1,B1,A2", `B2 (${n.B2.name}) â†’ A1 (${n.A1.name}) â†’ B1 (${n.B1.name}) â†’ A2 (${n.A2.name})`],
  ];
  const sel = $("#serveOrder");
  sel.innerHTML = opts.map(([v,t])=>`<option value="${v}">${t}</option>`).join("");
  const current = state.serveOrder.join(",");
  if ([...sel.options].some(o=>o.value===current)) sel.value = current;
}

function updateActionButtonLabels(){
  const nameOf = id => state.players[id]?.name || id;
  ["A1","A2","B1","B2"].forEach(id=>{
    ["GG","SG","ENF","FE"].forEach(act=>{
      const btn = document.querySelector(`button[data-player="${id}"][data-action="${act}"]`);
      if (btn) btn.textContent = `${nameOf(id)} Â· ${act}`;
    });
  });
}

function pushUndo(){ state.undoStack.push(deepClone(state)); if (state.undoStack.length>200) state.undoStack.shift(); }
function undo(){ if(!state.undoStack.length) return; const prev=state.undoStack.pop(); Object.keys(state).forEach(k=>delete state[k]); Object.assign(state,prev); render(); }

/* ========= LÃ³gica de juego ========= */
function closeGameIfNeeded(){
  const a = state.score.ptsA, b = state.score.ptsB;

  // GP (40â€“40) no cierra aÃºn
  if (a >= 3 && b >= 3 && a === b) return false;

  // Cierre sin ventaja:
  // - Si alguno >= 4 â†’ gana mayor
  // - Si ambos >=3 y no iguales â†’ ganÃ³ el Ãºltimo mayor (post GP)
  let winner = null;
  if (a >= 4 || b >= 4) winner = (a > b) ? "A" : "B";
  else if (a >= 3 && b >= 3 && a !== b) winner = (a > b) ? "A" : "B";

  if (winner){
    if (winner === "A") state.score.gamesA++; else state.score.gamesB++;
    resetGamePoints();
    nextServer();
    return true;
  }
  return false;
}

function checkSetEnd(){
  const gA = state.score.gamesA, gB = state.score.gamesB;
  const need = 6;
  if ((gA >= need || gB >= need) && Math.abs(gA-gB) >= 2){
    if (gA > gB) state.score.setsA++; else state.score.setsB++;
    state.score.gamesA = 0; state.score.gamesB = 0;
    resetGamePoints();
    const targetSets = Math.ceil(state.meta.setFormat / 2);
    if (state.score.setsA === targetSets || state.score.setsB === targetSets){
      state.meta.finished = true;
    }
  }
}

function recordPoint(playerId, type){
  if (!state.meta.started || state.meta.finished) return;

  pushUndo();

  // Determina ganador del punto y registra estadÃ­stica individual
  let winnerTeam;
  if (type==="GG" || type==="SG"){
    winnerTeam = teamOf(playerId);
    state.stats[playerId][type] += 1;
  } else { // ENF / FE â†’ punto para rival
    state.stats[playerId][type] += 1;
    winnerTeam = teamOf(playerId) === "A" ? "B" : "A";
  }

  if (winnerTeam === "A") state.score.ptsA++; else state.score.ptsB++;

  const preGameStr = `${tennisStr(state.score.ptsA, state.score.ptsB)} | Juegos ${state.score.gamesA}-${state.score.gamesB}`;
  const closed = closeGameIfNeeded();
  if (closed) checkSetEnd();

  const evento = (type==="ENF"||type==="FE") ? `Error ${state.players[playerId].name}` : state.players[playerId].name;
  state.log.push({ n: state.log.length+1, evento, type, winnerTeam, gameStr: preGameStr, server: serverName() });

  render();
}

/* ========= Persistencia ========= */
function autosave(){ try{ localStorage.setItem(KEY_AUTOSAVE, JSON.stringify(state)); }catch(e){} }
function loadAutosave(){
  try{
    const raw = localStorage.getItem(KEY_AUTOSAVE);
    if (!raw) return false;
    const st = JSON.parse(raw);
    Object.keys(state).forEach(k=> delete state[k]);
    Object.assign(state, st);
    return true;
  }catch(e){ return false; }
}

function saveToHistory(){
  try{
    const arr = JSON.parse(localStorage.getItem(KEY_SAVED) || "[]");
    const snap = deepClone(state);
    snap.savedAt = new Date().toISOString();
    arr.unshift(snap);
    while(arr.length>4) arr.pop();
    localStorage.setItem(KEY_SAVED, JSON.stringify(arr));
    renderSaved();
    alert("Partido guardado en historial (mÃ¡x. 4).");
  }catch(e){ alert("No se pudo guardar."); }
}

function renderSaved(){
  const box = $("#savedList");
  const arr = JSON.parse(localStorage.getItem(KEY_SAVED) || "[]");
  if (!arr.length){ box.innerHTML = "No hay partidos guardados todavÃ­a."; return; }
  box.innerHTML = arr.map((m,i)=>{
    const t = new Date(m.savedAt||m.meta?.createdAt||Date.now()).toLocaleString();
    const A = `${m.players.A1.name} & ${m.players.A2.name}`;
    const B = `${m.players.B1.name} & ${m.players.B2.name}`;
    const res = `${m.score.setsA}-${m.score.setsB} sets`;
    return `<div class="score" style="margin-bottom:6px">
      <div>
        <div class="tiny">#${i+1} Â· ${t}</div>
        <div>${A} <span class="tiny">vs</span> ${B}</div>
        <div class="tiny">Resultado: ${res}</div>
      </div>
      <div class="tabbar">
        <button class="btn ghost" data-load="${i}">Cargar</button>
        <button class="btn dng" data-del="${i}">Borrar</button>
        <button class="btn" data-export="${i}">CSV</button>
      </div>
    </div>`;
  }).join("");

  box.querySelectorAll("[data-load]").forEach(b=> b.onclick = ()=>{
    const idx = +b.getAttribute("data-load");
    const arr2 = JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
    const pick = arr2[idx]; if (!pick) return;
    Object.keys(state).forEach(k=> delete state[k]);
    Object.assign(state, pick);
    render();
    window.scrollTo({top:0,behavior:"smooth"});
  });
  box.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
    const idx = +b.getAttribute("data-del");
    const arr2 = JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
    arr2.splice(idx,1);
    localStorage.setItem(KEY_SAVED, JSON.stringify(arr2));
    renderSaved();
  });
  box.querySelectorAll("[data-export]").forEach(b=> b.onclick = ()=>{
    const idx = +b.getAttribute("data-export");
    const arr2 = JSON.parse(localStorage.getItem(KEY_SAVED)||"[]");
    if (arr2[idx]) downloadCSV(buildCSV(arr2[idx]), `doblejotaenlared_guardado_${idx+1}.csv`);
  });
}

/* ========= CSV ========= */
function buildCSV(snap){
  const s = snap || state;
  let lines = [];
  lines.push(["doblejotaenlared", new Date(s.meta.createdAt||Date.now()).toISOString(),
    `${s.players.A1.name} & ${s.players.A2.name}`,
    `${s.players.B1.name} & ${s.players.B2.name}`,
    `Sets ${s.score.setsA}-${s.score.setsB}`].join(","));
  lines.push("");
  lines.push("EstadÃ­sticas por jugadora");
  lines.push("Jugadora,Equipo,GG,SG,ENF,FE");
  ["A1","A2","B1","B2"].forEach(id=>{
    const t = teamOf(id);
    const r = s.stats[id]||{GG:0,SG:0,ENF:0,FE:0};
    lines.push([s.players[id].name,t,r.GG,r.SG,r.ENF,r.FE].join(","));
  });
  lines.push("");
  lines.push("Historial de puntos");
  lines.push("N,Evento,Tipo,Equipo Ganador,Marcador,Servidor");
  (s.log||[]).forEach(r=>{
    lines.push([r.n, `"${r.evento}"`, r.type, r.winnerTeam, `"${r.gameStr}"`, `"${r.server}"`].join(","));
  });
  lines.push("");
  lines.push("Resumen final");
  lines.push(`Sets A,${s.score.setsA},Sets B,${s.score.setsB}`);
  return lines.join("\r\n");
}
function downloadCSV(content, filename){
  const blob = new Blob([content], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename || "doblejotaenlared.csv";
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ========= Render ========= */
function render(){
  // TÃ­tulos equipos
  $("#nameTeamA").textContent = `Equipo A: ${state.players.A1.name} & ${state.players.A2.name}`;
  $("#nameTeamB").textContent = `Equipo B: ${state.players.B1.name} & ${state.players.B2.name}`;

  // Marcador
  $("#setsA").textContent = state.score.setsA;
  $("#setsB").textContent = state.score.setsB;
  $("#gamesA").textContent = state.score.gamesA;
  $("#gamesB").textContent = state.score.gamesB;
  $("#pointsA").textContent = state.score.ptsA;
  $("#pointsB").textContent = state.score.ptsB;
  $("#tennisScore").textContent = tennisStr(state.score.ptsA, state.score.ptsB);
  $("#serverNow").textContent = serverName();
  $("#stateNow").textContent = state.meta.finished ? "Partido finalizado" : (state.meta.started ? "Juego en curso" : "Listo");

  // Log
  const tbody = $("#tblLog tbody");
  tbody.innerHTML = "";
  state.log.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.n}</td><td>${r.evento}</td><td>${r.type}</td><td>${r.winnerTeam}</td><td>${r.gameStr}</td><td>${r.server}</td>`;
    tbody.appendChild(tr);
  });

  // Stats
  const s = state.stats;
  $("#statsPlayers").innerHTML = `
    <div class="grid cols-2">
      ${["A1","A2","B1","B2"].map(id=>{
        const nm = state.players[id].name;
        const t = teamOf(id);
        const r = s[id];
        return `<div class="kpi"><div class="box">
          <div class="tiny">${nm} (${t})</div>
          <div class="help">GG ${r.GG} Â· SG ${r.SG} Â· ENF ${r.ENF} Â· FE ${r.FE}</div>
        </div></div>`;
      }).join("")}
    </div>
  `;

  // Botones con nombres actualizados
  updateActionButtonLabels();

  // Persistencia y guardados
  renderSaved();
  autosave();
}

/* ========= Inicio / Eventos ========= */
function startReset(){
  syncNamesFromInputs();
  state.meta.setFormat = parseInt($("#setFormat").value,10);

  const seqStr = $("#serveOrder").value || "A1,B1,A2,B2";
  const seq = seqStr.split(",").filter(x=>["A1","A2","B1","B2"].includes(x));
  state.serveOrder = seq.length ? seq : ["A1","B1","A2","B2"];
  state.serveIndex = 0;

  state.score = { setsA:0, setsB:0, gamesA:0, gamesB:0, ptsA:0, ptsB:0 };
  ["A1","A2","B1","B2"].forEach(id=> state.stats[id]={GG:0,SG:0,ENF:0,FE:0});
  state.log = [];
  state.undoStack = [];
  state.meta.started = true;
  state.meta.finished = false;
  state.meta.createdAt = new Date().toISOString();
  state.meta.id = "match_"+Date.now();

  updateServeOrderOptions();
  render();
}

/* Listeners de nombres: actualiza todo al teclear */
["#pA1","#pA2","#pB1","#pB2"].forEach(sel=>{
  $(sel).addEventListener("input", ()=>{
    syncNamesFromInputs();
    updateServeOrderOptions();
    render();
  });
});

/* Listeners de puntos (delegaciÃ³n por seguridad) */
$("#actionsGrid").addEventListener("click", (ev)=>{
  const btn = ev.target.closest("button[data-player][data-action]");
  if (!btn) return;
  const player = btn.getAttribute("data-player");
  const action = btn.getAttribute("data-action");
  recordPoint(player, action);
});

/* Botones de control */
$("#btnStart").onclick = startReset;
$("#btnUndo").onclick = undo;
$("#btnEndSet").onclick = ()=>{
  if (!state.meta.started || state.meta.finished) return;
  if (state.score.gamesA===state.score.gamesB){ alert("Empate de juegos: no se puede cerrar el set manualmente."); return; }
  pushUndo();
  if (state.score.gamesA>state.score.gamesB) state.score.setsA++; else state.score.setsB++;
  state.score.gamesA=0; state.score.gamesB=0; resetGamePoints();
  const targetSets = Math.ceil(state.meta.setFormat/2);
  if (state.score.setsA===targetSets || state.score.setsB===targetSets) state.meta.finished=true;
  render();
};
$("#btnEndMatch").onclick = ()=>{ if (!state.meta.started) return; pushUndo(); state.meta.finished = true; render(); };

$("#btnExport").onclick = ()=> downloadCSV(buildCSV(), "doblejotaenlared.csv");
$("#btnSave").onclick = saveToHistory;

/* ==== Boot: carga autosave seguro, llena orden de servicio y renderiza ==== */
(function boot(){
  // Llenar opciones SIEMPRE antes de leer valor
  updateServeOrderOptions();

  // Intentar cargar autosave
  const ok = loadAutosave();

  // Reflejar nombres a inputs si venÃ­an de autosave
  $("#pA1").value = state.players.A1.name; $("#pA2").value = state.players.A2.name;
  $("#pB1").value = state.players.B1.name; $("#pB2").value = state.players.B2.name;

  // Asegurar que el selector muestre el orden actual (ya poblado)
  updateServeOrderOptions();

  // Primer render
  render();

  // Si no habÃ­a autosave, deja listo para iniciar; si habÃ­a, todo queda tal cual guardado.
})();
</script>
</body>
</html>
